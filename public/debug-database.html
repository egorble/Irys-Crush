<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Debug - IrysCrush PvP</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .container {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .room {
            background-color: #3a3a3a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .room.finished {
            border-left-color: #2196F3;
        }
        .room.pending {
            border-left-color: #FF9800;
        }
        .room.error {
            border-left-color: #f44336;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.danger {
            background-color: #f44336;
        }
        button.danger:hover {
            background-color: #da190b;
        }
        .status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.active { background-color: #4CAF50; }
        .status.finished { background-color: #2196F3; }
        .status.pending { background-color: #FF9800; }
        .status.submitted { background-color: #9C27B0; }
        pre {
            background-color: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <h1>üîç Database Debug - IrysCrush PvP</h1>
    
    <div class="container">
        <h2>Controls</h2>
        <button onclick="loadDatabaseStatus()">üîÑ Refresh Database Status</button>
        <button onclick="processPendingResults()" class="danger">‚ö° Process Pending Results</button>
        <button onclick="clearDisplay()">üßπ Clear Display</button>
    </div>

    <div class="container">
        <h2>Database Status</h2>
        <div id="status" class="loading">Click "Refresh Database Status" to load data</div>
    </div>

    <div class="container">
        <h2>Active Rooms</h2>
        <div id="rooms"></div>
    </div>

    <div class="container">
        <h2>Pending Blockchain Submissions</h2>
        <div id="pending"></div>
    </div>

    <div class="container">
        <h2>Raw Data</h2>
        <pre id="rawData"></pre>
    </div>

    <script>
        async function loadDatabaseStatus() {
            const statusDiv = document.getElementById('status');
            const roomsDiv = document.getElementById('rooms');
            const pendingDiv = document.getElementById('pending');
            const rawDataDiv = document.getElementById('rawData');
            
            statusDiv.innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                const response = await fetch('/api/pvp/debug/database');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load database status');
                }
                
                // Update status
                statusDiv.innerHTML = `
                    <p><strong>Total Active Rooms:</strong> ${data.summary.totalActiveRooms}</p>
                    <p><strong>Pending Blockchain Submissions:</strong> ${data.summary.totalPendingSubmissions}</p>
                    <p><strong>Last Updated:</strong> ${new Date().toLocaleString()}</p>
                `;
                
                // Update rooms
                if (data.activeRooms.length === 0) {
                    roomsDiv.innerHTML = '<p>No active rooms found</p>';
                } else {
                    roomsDiv.innerHTML = data.activeRooms.map(room => {
                        const statusClass = room.game_finished ? 'finished' : (room.game_started ? 'pending' : 'active');
                        const submissionStatus = room.submissionStatus;
                        
                        return `
                            <div class="room ${statusClass}">
                                <h3>Room ${room.room_id} 
                                    <span class="status ${statusClass}">
                                        ${room.game_finished ? 'Finished' : (room.game_started ? 'Started' : 'Active')}
                                    </span>
                                    ${room.blockchain_submitted ? '<span class="status submitted">Blockchain Submitted</span>' : ''}
                                </h3>
                                <p><strong>Host:</strong> ${room.host_address}</p>
                                <p><strong>Entry Fee:</strong> ${room.entry_fee}</p>
                                <p><strong>Players:</strong> ${room.players}/${room.max_players}</p>
                                <p><strong>Submissions:</strong> ${submissionStatus.submittedPlayers}/${submissionStatus.totalPlayers} 
                                    ${submissionStatus.allSubmitted ? '‚úÖ' : '‚è≥'}</p>
                                <p><strong>Created:</strong> ${new Date(room.created_at).toLocaleString()}</p>
                                ${room.finished_at ? `<p><strong>Finished:</strong> ${new Date(room.finished_at).toLocaleString()}</p>` : ''}
                                ${room.blockchain_tx_hash ? `<p><strong>TX Hash:</strong> ${room.blockchain_tx_hash}</p>` : ''}
                                
                                <details>
                                    <summary>Players Details</summary>
                                    ${room.playersDetails.map(player => `
                                        <p>‚Ä¢ ${player.player_address} ${player.is_host ? '(Host)' : ''} - Joined: ${new Date(player.joined_at).toLocaleString()}</p>
                                    `).join('')}
                                </details>
                            </div>
                        `;
                    }).join('');
                }
                
                // Update pending submissions
                if (data.pendingBlockchainSubmissions.length === 0) {
                    pendingDiv.innerHTML = '<p>No pending blockchain submissions</p>';
                } else {
                    pendingDiv.innerHTML = data.pendingBlockchainSubmissions.map(room => `
                        <div class="room pending">
                            <h3>Room ${room.room_id}</h3>
                            <p><strong>Host:</strong> ${room.host_address}</p>
                            <p><strong>Entry Fee:</strong> ${room.entry_fee}</p>
                            <p><strong>Finished:</strong> ${new Date(room.finished_at).toLocaleString()}</p>
                        </div>
                    `).join('');
                }
                
                // Update raw data
                rawDataDiv.textContent = JSON.stringify(data, null, 2);
                
            } catch (error) {
                statusDiv.innerHTML = `<p style="color: #f44336;">Error: ${error.message}</p>`;
                console.error('Error loading database status:', error);
            }
        }
        
        async function processPendingResults() {
            if (!confirm('Are you sure you want to process pending results? This will submit transactions to the blockchain.')) {
                return;
            }
            
            const statusDiv = document.getElementById('status');
            const originalContent = statusDiv.innerHTML;
            
            statusDiv.innerHTML = '<div class="loading">Processing pending results...</div>';
            
            try {
                const response = await fetch('/api/pvp/debug/process-pending', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to process pending results');
                }
                
                statusDiv.innerHTML = `
                    <div style="color: #4CAF50;">
                        <p><strong>‚úÖ ${data.message}</strong></p>
                        <details>
                            <summary>Results Details</summary>
                            ${data.results.map(result => `
                                <p>Room ${result.roomId}: ${result.status} ${result.error ? `(${result.error})` : ''}</p>
                            `).join('')}
                        </details>
                    </div>
                `;
                
                // Refresh data after processing
                setTimeout(() => {
                    loadDatabaseStatus();
                }, 2000);
                
            } catch (error) {
                statusDiv.innerHTML = `<p style="color: #f44336;">Error: ${error.message}</p>`;
                console.error('Error processing pending results:', error);
                
                // Restore original content after error
                setTimeout(() => {
                    statusDiv.innerHTML = originalContent;
                }, 5000);
            }
        }
        
        function clearDisplay() {
            document.getElementById('status').innerHTML = 'Click "Refresh Database Status" to load data';
            document.getElementById('rooms').innerHTML = '';
            document.getElementById('pending').innerHTML = '';
            document.getElementById('rawData').textContent = '';
        }
        
        // Auto-refresh every 30 seconds
        setInterval(loadDatabaseStatus, 30000);
    </script>
</body>
</html>