# –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó —á–∞—Å—É –º—ñ–∂ –≥—Ä–∞–≤—Ü—è–º–∏

## –ü—Ä–æ–±–ª–µ–º–∞

**–†—ñ–∑–Ω—ñ –≥—Ä–∞–≤—Ü—ñ –±–∞—á–∞—Ç—å —Ä—ñ–∑–Ω–∏–π —á–∞—Å –≥—Ä–∏** - –æ–¥–∏–Ω –≥—Ä–∞–≤–µ—Ü—å –±–∞—á–∏—Ç—å 1 —Ö–≤–∏–ª–∏–Ω—É, —ñ–Ω—à–∏–π 2 —Ö–≤–∏–ª–∏–Ω–∏ –¥–ª—è —Ç—ñ—î—ó –∂ –∫—ñ–º–Ω–∞—Ç–∏.

## –ü—Ä–∏—á–∏–Ω–∏ –ø—Ä–æ–±–ª–µ–º–∏

### 1. –ú–µ—Ä–µ–∂–µ–≤—ñ –∑–∞—Ç—Ä–∏–º–∫–∏
- –†—ñ–∑–Ω—ñ –≥—Ä–∞–≤—Ü—ñ –æ—Ç—Ä–∏–º—É—é—Ç—å –¥–∞–Ω—ñ –∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É –≤ —Ä—ñ–∑–Ω–∏–π —á–∞—Å
- –ú–æ–∂–ª–∏–≤—ñ —Ç–∏–º—á–∞—Å–æ–≤—ñ —Ä–æ–∑–±—ñ–∂–Ω–æ—Å—Ç—ñ —á–µ—Ä–µ–∑ –∑–∞—Ç—Ä–∏–º–∫–∏ –º–µ—Ä–µ–∂—ñ

### 2. –ö–µ—à—É–≤–∞–Ω–Ω—è –±—Ä–∞—É–∑–µ—Ä–∞
- –ë—Ä–∞—É–∑–µ—Ä–∏ –º–æ–∂—É—Ç—å –∫–µ—à—É–≤–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –≤–∏–∫–ª–∏–∫—ñ–≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É
- –†—ñ–∑–Ω—ñ –±—Ä–∞—É–∑–µ—Ä–∏/–≤–∫–ª–∞–¥–∫–∏ –º–æ–∂—É—Ç—å –º–∞—Ç–∏ —Ä—ñ–∑–Ω—ñ –∫–µ—à–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ

### 3. Fallback –ª–æ–≥—ñ–∫–∞
```javascript
gameTimeMinutes: gameTimeMinutes > 0 ? gameTimeMinutes : 2, // Fallback to 2 minutes
```
- –Ø–∫—â–æ –æ–¥–∏–Ω –≥—Ä–∞–≤–µ—Ü—å –æ—Ç—Ä–∏–º—É—î 0 –∞–±–æ –Ω–µ–≤–∞–ª—ñ–¥–Ω—ñ –¥–∞–Ω—ñ, –≤—ñ–Ω –±–∞—á–∏—Ç—å 2 —Ö–≤–∏–ª–∏–Ω–∏
- –Ü–Ω—à–∏–π –≥—Ä–∞–≤–µ—Ü—å –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ –¥–∞–Ω—ñ

### 4. –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ—ó —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
- –ö–æ–∂–µ–Ω –≥—Ä–∞–≤–µ—Ü—å –æ–±—Ä–æ–±–ª—è—î —á–∞—Å –Ω–µ–∑–∞–ª–µ–∂–Ω–æ
- –ù–µ–º–∞—î –º–µ—Ö–∞–Ω—ñ–∑–º—É –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –æ–¥–Ω–∞–∫–æ–≤–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤

## –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

### 1. –î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ `getRoomInfo` (`pvp-core.js`)

```javascript
async getRoomInfo(roomId) {
    console.log('üîç Fetching room info from contract for room:', roomId);
    const roomData = await this.contract.getPvPRoom(roomId);
    
    // Parse and validate game time with detailed logging
    const rawGameTime = roomData[2];
    const gameTimeSeconds = Number(rawGameTime);
    const gameTimeMinutes = Math.floor(gameTimeSeconds / 60);
    
    console.log('üïê DETAILED Room time parsing:', {
        roomId,
        rawGameTime: rawGameTime.toString(),
        rawGameTimeType: typeof rawGameTime,
        gameTimeSeconds,
        gameTimeMinutes,
        isValidSeconds: !isNaN(gameTimeSeconds),
        isValidMinutes: !isNaN(gameTimeMinutes),
        calculationCheck: `${gameTimeSeconds} / 60 = ${gameTimeSeconds / 60}`,
        floorResult: Math.floor(gameTimeSeconds / 60)
    });
    
    // –ö–†–ò–¢–ò–ß–ù–û: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ Time Manager –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ
    let finalGameTimeMinutes = gameTimeMinutes;
    if (window.pvpTimeManager) {
        const timeData = window.pvpTimeManager.setRoomTime(roomId, gameTimeSeconds, 'contract_fetch', 'seconds');
        finalGameTimeMinutes = timeData.minutes;
        
        console.log('üïê Time Manager processed contract time:', {
            originalSeconds: gameTimeSeconds,
            originalMinutes: gameTimeMinutes,
            timeManagerResult: timeData
        });
    }
    
    // ... —Ä–µ—à—Ç–∞ –∫–æ–¥—É
}
```

### 2. –ü–æ–¥–≤—ñ–π–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –≤ `onGameStarted` (`pvp-core.js`)

```javascript
async onGameStarted(roomId, host) {
    if (this.currentRoomId === roomId) {
        console.log('üéÆ Our game started!');
        
        // –ö–†–ò–¢–ò–ß–ù–û: –û—Ç—Ä–∏–º—É—î–º–æ —Å–≤—ñ–∂—ñ –¥–∞–Ω—ñ –∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
        console.log('üîÑ Fetching fresh room data for game start synchronization...');
        const roomInfo = await this.getRoomInfo(roomId);
        
        if (roomInfo.success && window.startPVPGame) {
            const isHost = roomInfo.room.host.toLowerCase() === (await this.signer.getAddress()).toLowerCase();
            
            // –ü–û–î–í–Ü–ô–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ Time Manager –¥–ª—è –≥–∞—Ä–∞–Ω—Ç—ñ—ó –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ
            let gameTimeMinutes = 2; // default
            if (window.pvpTimeManager) {
                // –°–ø–æ—á–∞—Ç–∫—É –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —á–∞—Å –∑ –æ—Ç—Ä–∏–º–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö –∫—ñ–º–Ω–∞—Ç–∏
                const roomTimeData = window.pvpTimeManager.setRoomTime(roomId, roomInfo.room.gameTimeMinutes, 'game_start_room', 'minutes');
                
                // –ü–æ—Ç—ñ–º –æ—Ç—Ä–∏–º—É—î–º–æ –ø—Ä—è–º–æ –∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É –¥–ª—è –ø–æ–¥–≤—ñ–π–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
                const contractTimeData = await window.pvpTimeManager.fetchAndCacheRoomTimeFromContract(roomId, this.contract);
                
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —á–∞—Å –∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É —è–∫ –Ω–∞–π–±—ñ–ª—å—à –Ω–∞–¥—ñ–π–Ω–∏–π
                gameTimeMinutes = contractTimeData.minutes;
                
                console.log('üïê GAME START Time synchronization:', {
                    roomId,
                    roomDataTime: roomInfo.room.gameTimeMinutes,
                    roomTimeManagerResult: roomTimeData,
                    contractTimeManagerResult: contractTimeData,
                    finalTime: gameTimeMinutes
                });
            }
            
            console.log('üöÄ Starting PVP game with synchronized time:', {
                roomId,
                gameTimeMinutes,
                gameTimeSeconds: gameTimeMinutes * 60,
                isHost,
                timestamp: new Date().toISOString()
            });
            
            window.startPVPGame(roomId, gameTimeMinutes, isHost);
        }
    }
}
```

### 3. –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –≤ Time Manager (`pvp-time-manager.js`)

```javascript
async fetchAndCacheRoomTimeFromContract(roomId, contract) {
    try {
        console.log(`üîç Time Manager: Fetching time for room ${roomId} from contract...`);
        
        const room = await contract.getPvPRoom(roomId);
        const rawGameTime = room.gameDuration || room[2]; // –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —Ä—ñ–∑–Ω–∏—Ö —Ñ–æ—Ä–º–∞—Ç—ñ–≤
        const gameDurationSeconds = Number(rawGameTime);
        
        console.log(`üîç Time Manager: Contract raw data for room ${roomId}:`, {
            rawGameTime: rawGameTime.toString(),
            rawGameTimeType: typeof rawGameTime,
            gameDurationSeconds,
            isValid: !isNaN(gameDurationSeconds) && gameDurationSeconds > 0
        });
        
        // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è
        if (isNaN(gameDurationSeconds) || gameDurationSeconds <= 0) {
            console.warn(`‚ö†Ô∏è Time Manager: Invalid time from contract for room ${roomId}, using default`);
            const defaultTime = this.setRoomTime(roomId, this.defaultGameTimeMinutes, 'contract_invalid', 'minutes');
            return defaultTime;
        }
        
        const timeData = this.setRoomTime(roomId, gameDurationSeconds, 'contract', 'seconds');
        
        console.log(`‚úÖ Time Manager: Room ${roomId} time fetched and cached:`, {
            roomId,
            contractSeconds: gameDurationSeconds,
            processedMinutes: timeData.minutes,
            processedSeconds: timeData.seconds,
            source: timeData.source
        });
        
        return timeData;
    } catch (error) {
        console.error(`‚ùå Time Manager: Failed to fetch time for room ${roomId}:`, error);
        
        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π —á–∞—Å —É –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏
        const defaultTime = this.setRoomTime(roomId, this.defaultGameTimeMinutes, 'error_fallback', 'minutes');
        return defaultTime;
    }
}
```

## –°—Ç—Ä–∞—Ç–µ–≥—ñ—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó

### 1. –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –¥–∂–µ—Ä–µ–ª —á–∞—Å—É
1. **–ö–æ–Ω—Ç—Ä–∞–∫—Ç (–ø—Ä—è–º–∏–π –≤–∏–∫–ª–∏–∫)** - –Ω–∞–π–≤–∏—â–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω—ñ—Å—Ç—å
2. **Time Manager –∫–µ—à** - —Å–µ—Ä–µ–¥–Ω—è –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω—ñ—Å—Ç—å  
3. **Fallback –∑–Ω–∞—á–µ–Ω–Ω—è** - –Ω–∞–π–Ω–∏–∂—á–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω—ñ—Å—Ç—å

### 2. –ü–æ–¥–≤—ñ–π–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ –≥—Ä–∏ —Ä–æ–±–∏—Ç—å—Å—è –¥–≤–∞ –∑–∞–ø–∏—Ç–∏:
  1. –ß–µ—Ä–µ–∑ `getRoomInfo` (–∑ –∫–µ—à—É–≤–∞–Ω–Ω—è–º)
  2. –ß–µ—Ä–µ–∑ `fetchAndCacheRoomTimeFromContract` (–ø—Ä—è–º–∏–π –∑–∞–ø–∏—Ç)
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä—è–º–æ–≥–æ –∑–∞–ø–∏—Ç—É

### 3. –î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- –õ–æ–≥—É—î—Ç—å—Å—è –∫–æ–∂–µ–Ω –∫—Ä–æ–∫ –æ–±—Ä–æ–±–∫–∏ —á–∞—Å—É
- –ú–æ–∂–Ω–∞ –≤—ñ–¥—Å—Ç–µ–∂–∏—Ç–∏ –¥–µ —Å–∞–º–µ –≤–∏–Ω–∏–∫–∞—î —Ä–æ–∑–±—ñ–∂–Ω—ñ—Å—Ç—å
- Timestamp –¥–ª—è –∫–æ–∂–Ω–æ—ó –æ–ø–µ—Ä–∞—Ü—ñ—ó

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –î–µ–±–∞–≥ —Å–∫—Ä–∏–ø—Ç `debug-time-sync.js`
```bash
node debug-time-sync.js
```

–°–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç—É—î:
- –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–≤–æ–º–∞ "–≥—Ä–∞–≤—Ü—è–º–∏" –æ–¥–Ω–æ—á–∞—Å–Ω–æ
- –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –æ–±—Ä–æ–±–∫–∏
- –ê–Ω–∞–ª—ñ–∑ –º–Ω–æ–∂–∏–Ω–Ω–∏—Ö –∫—ñ–º–Ω–∞—Ç
- –í–∏—è–≤–ª–µ–Ω–Ω—è —Ä–æ–∑–±—ñ–∂–Ω–æ—Å—Ç–µ–π

### –©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –≤ –ª–æ–≥–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞

1. **–ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –∫—ñ–º–Ω–∞—Ç–∏:**
```
üìù Creating room with params: { gameDurationSeconds: 120 }
```

2. **–ü—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –∫—ñ–º–Ω–∞—Ç—É:**
```
üïê DETAILED Room time parsing: { 
  rawGameTime: "120", 
  gameTimeSeconds: 120, 
  gameTimeMinutes: 2 
}
```

3. **–ü—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ –≥—Ä–∏:**
```
üïê GAME START Time synchronization: {
  finalTime: 2
}
```

4. **–£ Time Manager:**
```
‚úÖ Time Manager: Room 123 time fetched and cached: {
  contractSeconds: 120,
  processedMinutes: 2
}
```

## –û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–û–±–∏–¥–≤–∞ –≥—Ä–∞–≤—Ü—ñ –±–∞—á–∞—Ç—å –æ–¥–Ω–∞–∫–æ–≤–∏–π —á–∞—Å**
‚úÖ **–î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º**
‚úÖ **–ü–æ–¥–≤—ñ–π–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ**
‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —á–∞—Å–æ–º —á–µ—Ä–µ–∑ Time Manager**
‚úÖ **Fallback –º–µ—Ö–∞–Ω—ñ–∑–º–∏ –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ**

## –Ø–∫—â–æ –ø—Ä–æ–±–ª–µ–º–∞ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è

1. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏** - —á–∏ –æ–±–∏–¥–≤–∞ –≥—Ä–∞–≤—Ü—ñ –æ—Ç—Ä–∏–º—É—é—Ç—å –æ–¥–Ω–∞–∫–æ–≤—ñ `rawGameTime` –∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É
2. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –º–µ—Ä–µ–∂—É** - —á–∏ –Ω–µ–º–∞—î –∑–∞—Ç—Ä–∏–º–æ–∫ –∞–±–æ –ø–æ–º–∏–ª–æ–∫ –ø—Ä–∏ –∑–∞–ø–∏—Ç–∞—Ö
3. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–µ—à** - –æ—á–∏—Å—Ç—ñ—Ç—å –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞ —Ç–∞ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É
4. **–ó–∞–ø—É—Å—Ç—ñ—Ç—å –¥–µ–±–∞–≥ —Å–∫—Ä–∏–ø—Ç** - –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –Ω–∞ —Ä—ñ–≤–Ω—ñ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É